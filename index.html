<html>
    <head>
        <title>Spectrogram</title>
        <meta charset="UTF-8"/>
        <style>
            body {
                margin: 0;
                background: black;
                width: 100%;
                height: 100%;
            }

            button {
                width: 100%;
                height: 100%;
                color: white;
                background: black;
            }

            canvas#spectrogram {
                width: 100%;
                height: 100%;
                display: none;
            }
        </style>
    </head>
    <body>
        <!-- canvas height should match the number of fft bins, which is our fftSize / 2 -->
        <button onclick="spectrogram()">Tap to start</button>
        <canvas 
            id="spectrogram"
            height="1024"
            width="1024"
        ></canvas>
    </body>
    <script>
        function spectrogram() {
            var audioCtx = new(window.AudioContext || window.webkitAudioContext)();
            var analyser = audioCtx.createAnalyser();
            var source;

            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({audio: true, video: false}).then(showAudioStream)
            }

            analyser.fftSize = 2048 * 2; 
            var bufferLength = analyser.frequencyBinCount;
            var dataArray = new Uint8Array(bufferLength);
            var canvas = document.getElementById("spectrogram");
            var canvasCtx = canvas.getContext("2d");
            canvasCtx.globalCompositeOperation = "source-over";

            function showAudioStream(stream) {
                document.querySelector('button').style.display = "none";
                document.querySelector('canvas').style.display = "block";
                source = audioCtx.createMediaStreamSource(stream)
                source.connect(analyser)
                draw();
            }

            function draw() {
                // draw 1 time slice per column
                analyser.getByteFrequencyData(dataArray);
                for (var y = 0; y < bufferLength / 2; y++) {
                    intensity = dataArray[y];
                    canvasCtx.fillStyle = `rgb(${intensity},${intensity},${intensity})`
                    canvasCtx.fillRect(canvas.width - 1, canvas.height - mel(y), 1, 1)
                }

                // shift canvas contents left by 1 pixel
                canvasCtx.drawImage(canvasCtx.canvas, -1, 0);

                requestAnimationFrame(draw);
            }

            function mel(f) {
                return 2595 * Math.log(1 + f / 700) / Math.log(10)
            }
        }
    </script>
</html>
