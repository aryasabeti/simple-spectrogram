<html>
    <head>
        <title>Spectrogram</title>
        <meta charset="UTF-8"/>
    </head>
    <body style="margin: 0; background: black">
        <!-- canvas height should match the number of fft bins, which is our fftSize / 2 -->
        <canvas id="spectrogram" style="width: 100%; height: 100%;" height="512"></canvas>
    </body>
    <script>
        var audioCtx = new(window.AudioContext || window.webkitAudioContext)();
        var analyser = audioCtx.createAnalyser();
        var source;

        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia ({audio: true, video: false}).then(
                function(stream) {
                    source = audioCtx.createMediaStreamSource(stream)
                    source.connect(analyser)
                }
            )
        }

        analyser.fftSize = 2048;
        var bufferLength = analyser.frequencyBinCount;
        var displayBuckets = bufferLength / 2 // ignore above 10khz-ish. canvas height changes to match
        var dataArray = new Uint8Array(bufferLength);
        var canvas = document.getElementById("spectrogram");
        var canvasCtx = canvas.getContext("2d");

        function draw() {
            // draw 1 time slice per column
            analyser.getByteFrequencyData(dataArray);
            for (var y = 0; y < bufferLength / 2; y++) {
                intensity = dataArray[y] * (dataArray[y] / 256);
                canvasCtx.fillStyle = `rgb(${intensity},${intensity},${intensity})`
                canvasCtx.fillRect(canvas.width - 1, canvas.height - y, 1, 1)
            }

            // shift canvas contents left by 1 pixel
            canvasCtx.globalCompositeOperation = "copy";
            canvasCtx.drawImage(canvasCtx.canvas, -1, 0);
            canvasCtx.globalCompositeOperation = "source-over"

            requestAnimationFrame(draw);
        }

        draw();      
    </script>
</html>
